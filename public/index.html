<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProChess - Complete Edition</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg-body: #1a1614; --bg-sidebar: #2b2420;
            --board-light: #f0d9b5; --board-dark: #b58863;  
            --accent: #dca355; --selected: rgba(255, 255, 0, 0.3);
            --piece-white: #fdfdfd; --piece-black: #1a1a1a; 
            --log-bg: #212121; --log-alt: #262626;
            --sq-size: 70px;
            /* Added Special Move Color */
            --special-move: rgba(85, 80, 161, 0.6); 
        }

        body { background-color: var(--bg-body); color: #ebecd0; margin: 0; font-family: "Segoe UI", sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        .top-nav { position: fixed; top: 10px; left: 10px; z-index: 1100; display: none; }
        .back-nav-btn { background: rgba(0,0,0,0.6); color: var(--accent); border: 1px solid var(--accent); padding: 8px 14px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }

        #welcome-screen, #difficulty-screen, #player-names-screen, #online-lobby-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #3d2b1f 0%, #1a1614 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; padding: 20px; box-sizing: border-box; }
        #difficulty-screen, #player-names-screen, #online-lobby-screen { display: none; }
        
        .input-group { margin: 10px 0; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .input-group label { margin-bottom: 5px; color: var(--accent); font-weight: bold; }
        .player-input { background: #2b2420; border: 1px solid var(--accent); color: white; padding: 10px; border-radius: 4px; width: 90%; max-width: 250px; text-align: center; font-size: 1rem; }

        .mode-btn { background: #4a3728; color: #f0d9b5; border: 2px solid var(--accent); padding: 12px 24px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; min-width: 160px; margin: 8px; transition: 0.3s; }
        .mode-btn:hover { background: var(--accent); color: #1a1614; }

        /* PROMOTION MODAL */
        #promo-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 2500; display: none; align-items: center; justify-content: center; border-radius: 4px; }
        .promo-box { background: #f0d9b5; padding: 20px; border-radius: 8px; display: flex; gap: 15px; border: 3px solid var(--accent); }
        .promo-choice { font-size: 45px; cursor: pointer; color: #1a1a1a; transition: 0.2s; }
        .promo-choice:hover { transform: scale(1.2); }

        #game-container { display: none; flex-direction: row; gap: 20px; padding: 10px; background: #2b2420; border-radius: 8px; border: 1px solid #3d332d; position: relative; max-width: 95vw; }
        .board-container { position: relative; padding: 25px; background: #3d2b1f; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        
        .coord-v { position: absolute; left: 8px; top: 25px; height: calc(var(--sq-size) * 8); display: grid; grid-template-rows: repeat(8, 1fr); align-items: center; color: var(--accent); font-weight: bold; font-size: 12px; }
        .coord-h { position: absolute; bottom: 5px; left: 25px; width: calc(var(--sq-size) * 8); display: grid; grid-template-columns: repeat(8, 1fr); text-align: center; color: var(--accent); font-weight: bold; font-size: 12px; }

        #board-wrapper { position: relative; width: calc(var(--sq-size) * 8); height: calc(var(--sq-size) * 8); background: #000; }
        #board-grid { display: grid; grid-template-columns: repeat(8, var(--sq-size)); grid-template-rows: repeat(8, var(--sq-size)); }
        .sq { width: var(--sq-size); height: var(--sq-size); display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; z-index: 5; }
        .l { background-color: var(--board-light); } .d { background-color: var(--board-dark); }
        
        .sq.hint-move::after { content: ""; width: 25%; height: 25%; background: rgba(0, 0, 0, 0.15); border-radius: 50%; pointer-events: none; }
        .sq.hint-capture::after { content: ""; width: 90%; height: 90%; border: 3px solid rgba(0, 0, 0, 0.1); border-radius: 50%; pointer-events: none; position: absolute; }
        /* Special Hint Highlight */
        .sq.hint-special { background: radial-gradient(circle, var(--special-move) 40%, transparent 80%) !important; }
        
        .sq.selected { background-color: var(--selected) !important; }

        #piece-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .piece { width: var(--sq-size); height: var(--sq-size); position: absolute; display: flex; justify-content: center; align-items: center; font-size: calc(var(--sq-size) * 0.75); transition: all(0.22s) ease; }
        .white-piece { color: var(--piece-white); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        .black-piece { color: var(--piece-black); filter: drop-shadow(0 1px 1px rgba(255,255,255,0.1)); }

        #win-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; }
        .win-box { background: #f0d9b5; color: #1a1614; padding: 20px; border-radius: 8px; border: 3px solid var(--accent); text-align: center; width: 80%; }

        #check-alert-msg { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); background: #d32f2f; color: white; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; transition: 0.4s ease; z-index: 3000; opacity: 0; pointer-events: none; white-space: nowrap; }
        #check-alert-msg.show { top: 10px; opacity: 1; }
        
        /* SIDEBAR STABLE HEIGHT & SCROLL LOGIC */
        .sidebar { 
            width: 250px; 
            display: flex; 
            flex-direction: column; 
            height: calc(var(--sq-size) * 8 + 50px); 
            overflow: hidden; 
        }
        .timer-box { background: #1a1614; padding: 10px; border-radius: 6px; text-align: center; border-left: 4px solid #444; margin-bottom: 5px; }
        .timer-box.active { border-left-color: var(--accent); }
        .timer-display { font-family: monospace; font-size: 1.8rem; color: var(--accent); font-weight: bold; }

        .move-history { 
            height: 120px;
            margin: 5px 0; 
            overflow-y: auto; 
            background: var(--log-bg); 
            border-radius: 6px; 
            border: 1px solid #3d332d; 
            padding: 5px;
        }

        /* CUSTOM SCROLLBAR STYLING */
        .move-history::-webkit-scrollbar, .chat-box-area::-webkit-scrollbar { width: 6px; }
        .move-history::-webkit-scrollbar-track, .chat-box-area::-webkit-scrollbar-track { background: #1a1614; }
        .move-history::-webkit-scrollbar-thumb, .chat-box-area::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        .log-row { display: grid; grid-template-columns: 35px 1fr 1fr; padding: 6px 0; border-bottom: 1px solid #2d2b28; align-items: center; font-size: 0.9rem; }
        .log-num { color: #666; text-align: center; }
        .log-move { font-weight: bold; color: #ccc; padding-left: 8px; }

        /* TOAST STYLE */
        #copy-toast { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #1a1614; padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 14px; opacity: 0; transition: 0.5s ease; z-index: 9999; pointer-events: none; }
        #copy-toast.show { opacity: 1; bottom: 70px; }

        /* NEW CHAT CSS */
        .chat-container { flex-grow: 1; display: flex; flex-direction: column; background: var(--log-bg); border-radius: 6px; border: 1px solid #3d332d; overflow: hidden; margin-bottom: 5px; }
        .chat-box-area { flex-grow: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 4px; font-size: 0.8rem; }
        .chat-msg { padding: 4px 8px; border-radius: 4px; max-width: 85%; word-wrap: break-word; }
        .chat-msg.me { align-self: flex-end; background: #4a3728; color: var(--accent); }
        .chat-msg.them { align-self: flex-start; background: #333; color: #ddd; }
        .quick-chat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; background: #1a1614; }
        .quick-chat-btn { background: #3d2b1f; border: 1px solid #4a3728; color: #aaa; padding: 4px 0; font-size: 0.65rem; cursor: pointer; text-align: center; }
        .chat-input-row { display: flex; border-top: 1px solid #3d332d; }
        .chat-input-row input { background: none; border: none; color: white; padding: 8px; flex-grow: 1; outline: none; font-size: 0.8rem; }

        @keyframes shake { 0% { transform: translate(1px, 1px); } 20% { transform: translate(-3px, 0px); } 40% { transform: translate(3px, 2px); } 60% { transform: translate(-1px, -1px); } 100% { transform: translate(0px, 0px); } }
        .shake { animation: shake 0.3s; }

        @media (max-width: 850px) {
            #game-container { flex-direction: column; align-items: center; overflow-y: auto; max-height: 90vh; }
            .sidebar { width: 100%; min-height: auto; height: auto; }
            .move-history { height: 100px; }
            :root { --sq-size: 40px; }
        }
    </style>
</head>
<body>

    <div id="copy-toast">CODE COPIED!</div>
    <div id="promo-overlay"><div class="promo-box" id="promo-choices"></div></div>
    <div id="check-alert-msg">CHECK!</div>
    <div class="top-nav" id="top-nav-bar"><button class="back-nav-btn" onclick="location.reload()">‚Üê MENU</button></div>

    <div id="welcome-screen">
        <h1 style="font-size: 4rem; color: var(--accent); margin: 0 0 20px 0;">PRO CHESS</h1>
        <div class="btn-group">
            <button class="mode-btn" onclick="showPlayerNameInput()">2 PLAYER</button>
            <button class="mode-btn" onclick="showDifficulty()">AI BOT</button>
            <button class="mode-btn" onclick="showOnlineLobby()">ONLINE P2P</button>
        </div>
    </div>

    <div id="online-lobby-screen">
        <h2 style="font-size: 2rem; color: var(--accent);">ONLINE MULTIPLAYER</h2>
        <div class="input-group">
            <label>Your Name</label>
            <input type="text" id="online-name" class="player-input" placeholder="Enter Name" maxlength="12">
        </div>
        <div id="host-controls">
            <button class="mode-btn" onclick="hostP2PGame()">1. HOST GAME</button>
            <div id="p2p-id-display" onclick="copyToClipboard()" style="display:none; margin: 10px; padding: 10px; border: 1px dashed var(--accent); color: white; cursor: pointer; background: rgba(0,0,0,0.2); border-radius: 8px;">
                <span style="font-size: 0.7rem; color: #888;">YOUR ID (CLICK TO COPY):</span><br>
                <b id="my-p2p-id" style="color:var(--accent); font-size: 1.5rem; letter-spacing: 2px;">...</b>
                <p style="font-size: 0.7rem; color:#aaa; margin-top: 5px;">Share this ID with your friend</p>
            </div>
        </div>
        <div style="margin: 15px; color: #666;">‚Äî OR ‚Äî</div>
        <div id="join-controls">
            <input type="text" id="join-peer-id" class="player-input" placeholder="Friend's ID">
            <button class="mode-btn" onclick="joinP2PGame()">2. JOIN GAME</button>
        </div>
        <button class="mode-btn" style="background:none; border-color:#444;" onclick="location.reload()">BACK</button>
    </div>

    <div id="player-names-screen">
        <h2 style="font-size: 2rem; color: var(--accent);">PLAYER NAMES</h2>
        <div class="input-group"><label>White Player</label><input type="text" id="p1-name" class="player-input" placeholder="Player 1" maxlength="12"></div>
        <div class="input-group"><label>Black Player</label><input type="text" id="p2-name" class="player-input" placeholder="Player 2" maxlength="12"></div>
        <button class="mode-btn" onclick="startGame('2P')">START MATCH</button>
    </div>

    <div id="difficulty-screen">
        <h2 style="font-size: 2rem; color: var(--accent);">AI LEVEL</h2>
        <div class="btn-group">
            <button class="mode-btn" onclick="startGame('AI', 1)">NOVICE</button>
            <button class="mode-btn" onclick="startGame('AI', 2)">PRO</button>
            <button class="mode-btn" onclick="startGame('AI', 3)">MASTER</button>
        </div>
    </div>

    <div id="game-container">
        <div class="board-container">
            <div class="coord-v"><span>8</span><span>7</span><span>6</span><span>5</span><span>4</span><span>3</span><span>2</span><span>1</span></div>
            <div id="board-wrapper">
                <div id="board-grid"></div>
                <div id="piece-layer"></div>
                <div id="win-overlay">
                    <div class="win-box">
                        <h1 id="win-status" style="margin:0;">CHECKMATE</h1>
                        <h2 id="winner-label" style="font-size: 1rem; margin: 10px 0 20px 0;"></h2>
                        <button class="mode-btn" onclick="location.reload()">NEW MATCH</button>
                    </div>
                </div>
            </div>
            <div class="coord-h"><span>A</span><span>B</span><span>C</span><span>D</span><span>E</span><span>F</span><span>G</span><span>H</span></div>
        </div>

        <div class="sidebar">
            <div id="card-black" class="timer-box">
                <div id="display-name-black" style="font-size: 11px; font-weight: bold; color: #aaa;">BLACK</div>
                <div id="timer-black" class="timer-display">10:00</div>
            </div>
            <div class="move-history" id="log-container"></div>
            
            <div class="chat-container">
                <div class="chat-box-area" id="chat-box"></div>
                <div class="quick-chat-grid">
                    <div class="quick-chat-btn" onclick="sendQuickChat('GL! üçÄ')">GL!</div>
                    <div class="quick-chat-btn" onclick="sendQuickChat('Nice! üß†')">Nice</div>
                    <div class="quick-chat-btn" onclick="sendQuickChat('GG! ü§ù')">GG</div>
                </div>
                <div class="chat-input-row">
                    <input type="text" id="chat-input" placeholder="Message..." onkeydown="if(event.key==='Enter') sendUserChat()">
                </div>
            </div>

            <div id="card-white" class="timer-box active">
                <div id="display-name-white" style="font-size: 11px; font-weight: bold; color: #aaa;">WHITE</div>
                <div id="timer-white" class="timer-display">10:00</div>
            </div>
        </div>
    </div>

<script>
(function() {
    const socket = io(); // WebSocket initialization
    const GLYPHS = { white: { k:'‚ôî', q:'‚ôï', r:'‚ôñ', b:'‚ôó', n:'‚ôò', p:'‚ôô' }, black: { k:'‚ôö', q:'‚ôõ', r:'‚ôú', b:'‚ôù', n:'‚ôû', p:'‚ôü' } };
    const PIECE_VALUES = { p: 10, n: 30, b: 30, r: 50, q: 90, k: 900 };

    // Preservation of your Audio/State Variables
    let audioCtx, buffers = {};
    let board = [], turn = 'white', selected = null, legalMoves = [], gameMode = '2P', aiLevel = 1, moveCount = 1;
    let timerInterval, times = { white: 600, black: 600 }, gameActive = false, pNames = { white: "White", black: "Black" }, enPassantTarget = null;
    let myRole, currentRoomId; 

    function initAudio() {
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const urls = { move: 'Move.mp3', capture: 'Capture.mp3', check: 'Check.mp3', mate: 'GenericNotify.mp3' };
            for (const [k, v] of Object.entries(urls)) {
                fetch('https://raw.githubusercontent.com/lichess-org/lila/master/public/sound/standard/' + v)
                .then(r => r.arrayBuffer()).then(ab => audioCtx.decodeAudioData(ab)).then(buf => buffers[k] = buf);
            }
        } catch(e) {}
    }
    function play(k) { if (audioCtx && buffers[k]) { const s = audioCtx.createBufferSource(); s.buffer = buffers[k]; s.connect(audioCtx.destination); s.start(0); } }

    // --- REPLACED P2P WITH WEBSOCKET LOGIC ---
    window.showOnlineLobby = () => { 
        document.getElementById('welcome-screen').style.display='none'; 
        document.getElementById('online-lobby-screen').style.display='flex'; 
    };

    window.hostP2PGame = () => {
        const name = document.getElementById('online-name').value.trim();
        if(!name) { alert("Enter your name first!"); return; }
        pNames.white = name;
        socket.emit('create-room', name);
    };

    window.joinP2PGame = () => {
        const targetId = document.getElementById('join-peer-id').value.trim().toUpperCase();
        const name = document.getElementById('online-name').value.trim();
        if(!name || !targetId) { alert("Enter Name and ID!"); return; }
        pNames.black = name;
        currentRoomId = targetId;
        socket.emit('join-room', { roomId: targetId, name: name });
    };

    // WebSocket Listeners
    socket.on('room-created', (id) => {
        currentRoomId = id;
        document.getElementById('my-p2p-id').innerText = id;
        document.getElementById('p2p-id-display').style.display = 'block';
        document.getElementById('host-controls').querySelector('button').style.display = 'none';
    });

    socket.on('player-joined', ({ opponent, color }) => {
        myRole = color;
        if(color === 'white') pNames.black = opponent;
        else pNames.white = opponent;
        startGame('P2P');
    });

    socket.on('remote-move', (data) => {
        executeMove(data.fR, data.fC, data.tR, data.tC, data.mType, true);
    });

    socket.on('remote-chat', (msg) => addChatMsg(msg, 'them'));
    socket.on('error-msg', (msg) => alert(msg));

    // --- GAME LOGIC (UNCHANGED) ---
    window.copyToClipboard = () => {
        const idText = document.getElementById('my-p2p-id').innerText;
        navigator.clipboard.writeText(idText).then(() => {
            const toast = document.getElementById('copy-toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        });
    };

    window.sendUserChat = () => {
        const input = document.getElementById('chat-input');
        if(!input.value.trim() || !currentRoomId) return;
        addChatMsg(input.value, 'me');
        socket.emit('chat', { roomId: currentRoomId, msg: input.value });
        input.value = '';
    };

    window.sendQuickChat = (msg) => { 
        if(currentRoomId) { 
            addChatMsg(msg, 'me'); 
            socket.emit('chat', { roomId: currentRoomId, msg: msg }); 
        } 
    };

    function addChatMsg(msg, side) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `chat-msg ${side}`;
        div.innerText = msg;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // --- ENGINE CORE (PRESERVED) ---
    window.showDifficulty = () => { document.getElementById('welcome-screen').style.display='none'; document.getElementById('difficulty-screen').style.display='flex'; };
    window.showPlayerNameInput = () => { document.getElementById('welcome-screen').style.display='none'; document.getElementById('player-names-screen').style.display='flex'; };
    
    window.startGame = (mode, level = 1) => {
        initAudio(); gameMode = mode; aiLevel = level;
        if(mode !== 'P2P') {
            pNames.white = document.getElementById('p1-name').value || "White";
            pNames.black = (mode === 'AI') ? "AI Bot" : (document.getElementById('p2-name').value || "Black");
        }
        document.getElementById('display-name-white').innerText = pNames.white.toUpperCase();
        document.getElementById('display-name-black').innerText = pNames.black.toUpperCase();
        document.querySelectorAll('#welcome-screen, #difficulty-screen, #player-names-screen, #online-lobby-screen').forEach(s => s.style.display='none');
        document.getElementById('game-container').style.display='flex';
        document.getElementById('top-nav-bar').style.display='block';
        gameActive = true; initBoard(); startTimer();
    };

    function executeMove(fR, fC, tR, tC, moveType, fromRemote = false) {
        const piece = board[fR][fC]; const isCap = board[tR][tR] !== null || moveType === 'enPassant';
        if (isCap) { document.getElementById('board-wrapper').classList.add('shake'); setTimeout(()=>document.getElementById('board-wrapper').classList.remove('shake'), 300); if("vibrate" in navigator) navigator.vibrate(50); }
        if (moveType === 'enPassant') board[fR][tC] = null;
        if (moveType === 'castle') { const rc = tC === 6 ? 7 : 0, nrc = tC === 6 ? 5 : 3; board[tR][nrc] = board[tR][rc]; board[tR][rc] = null; }
        
        updateLog(fC, tR, tC, isCap, piece.type);
        board[tR][tC] = piece; board[fR][fC] = null; piece.hasMoved = true;
        enPassantTarget = (piece.type === 'p' && Math.abs(tR - fR) === 2) ? {r: (fR + tR)/2, c: fC} : null;
        
        // WebSocket Emission
        if (gameMode === 'P2P' && !fromRemote) {
            socket.emit('move', { roomId: currentRoomId, moveData: { fR, fC, tR, tC, mType: moveType } });
        }
        
        if (piece.type === 'p' && (tR === 0 || tR === 7)) { showPromotion(tR, tC, isCap); return; }
        finalizeTurn(isCap);
    }

    // ... Rest of your engine logic (initBoard, getLegalMoves, isCheck, etc.) stays exactly the same ...
    // Note: Ensure all functions like getLegalMoves, render, finalizeTurn are included from your original script.
    
    function startTimer() {
        timerInterval = setInterval(() => {
            if (!gameActive) return;
            times[turn]--;
            const m = Math.floor(times[turn] / 60), s = times[turn] % 60;
            const timerEl = document.getElementById(`timer-${turn}`);
            if(timerEl) timerEl.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            document.getElementById('card-white').classList.toggle('active', turn === 'white');
            document.getElementById('card-black').classList.toggle('active', turn === 'black');
            if (times[turn] <= 0) endGame(turn === 'white' ? 'black' : 'white', "TIME OUT");
        }, 1000);
    }

    function initBoard() {
        const layout = [['r','n','b','q','k','b','n','r'], ['p','p','p','p','p','p','p','p'], ...Array(4).fill(null).map(() => Array(8).fill(null)), ['P','P','P','P','P','P','P','P'], ['R','N','B','Q','K','B','N','R']];
        board = layout.map(row => row.map(c => c ? { id: Math.random().toString(36).substr(2,9), type: c.toLowerCase(), color: c === c.toUpperCase() ? 'white' : 'black', hasMoved: false } : null));
        const grid = document.getElementById('board-grid'); grid.innerHTML = '';
        for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
            const sq = document.createElement('div'); sq.id = `sq-${r}-${c}`; sq.className = `sq ${(r+c)%2===0 ? 'l' : 'd'}`;
            sq.onclick = () => handleClick(r, c); grid.appendChild(sq);
        }
        render();
    }

    function handleClick(r, c) {
        if (!gameActive || (gameMode === 'P2P' && turn !== myRole)) return;
        if (selected && legalMoves.some(m => m.r === r && m.c === c)) {
            const move = legalMoves.find(m => m.r === r && m.c === c);
            executeMove(selected.r, selected.c, r, c, move.type); return;
        }
        if (board[r][c]?.color === turn) { selected = {r, c}; legalMoves = getLegalMoves(r, c, board); render(); }
    }

    function finalizeTurn(isCap) {
        turn = turn === 'white' ? 'black' : 'white'; selected = null; legalMoves = [];
        const check = isCheck(turn, board);
        if (check && hasLegalMoves(turn)) { play('check'); const msg = document.getElementById('check-alert-msg'); msg.innerText = pNames[turn].toUpperCase() + " IS IN CHECK!"; msg.classList.add('show'); setTimeout(() => msg.classList.remove('show'), 2000); }
        else play(isCap ? 'capture' : 'move');
        if (!hasLegalMoves(turn)) endGame(turn === 'white' ? 'black' : 'white', check ? "CHECKMATE" : "STALEMATE");
        render();
        if (gameActive && gameMode === 'AI' && turn === 'black') setTimeout(makeAI, 500);
    }

    function showPromotion(r, c, isCap) {
        const overlay = document.getElementById('promo-overlay'); const box = document.getElementById('promo-choices'); box.innerHTML = '';
        ['q','r','b','n'].forEach(type => {
            const el = document.createElement('div'); el.className = 'promo-choice'; el.innerText = GLYPHS[turn][type];
            el.onclick = () => { board[r][c].type = type; overlay.style.display = 'none'; finalizeTurn(isCap); }; box.appendChild(el);
        });
        overlay.style.display = 'flex';
    }

    function getLegalMoves(r, c, b) {
        const moves = getRawMoves(r, c, b); const p = b[r][c];
        if (p.type === 'k' && !p.hasMoved && !isCheck(turn, b)) {
            [[7, 'ks', [5,6]], [0, 'qs', [1,2,3]]].forEach(([rk, side, path]) => {
                if (b[r][rk]?.type === 'r' && !b[r][rk].hasMoved && path.every(col => !b[r][col])) {
                    if (path.slice(-2).every(col => { const tmp = JSON.parse(JSON.stringify(b)); tmp[r][col] = tmp[r][c]; return !isCheck(turn, tmp); })) moves.push({r, c: side === 'ks' ? 6 : 2, type: 'castle'});
                }
            });
        }
        return moves.filter(m => { const cp = JSON.parse(JSON.stringify(b)); if (m.type === 'enPassant') cp[r][m.c] = null; cp[m.r][m.c] = cp[r][c]; cp[r][c] = null; return !isCheck(turn, cp); });
    }

    function getRawMoves(r, c, b) {
        const p = b[r][c]; let m = []; const dir = p.color === 'white' ? -1 : 1;
        if (p.type === 'p') {
            if (!b[r+dir]?.[c]) { m.push({r: r+dir, c, type:'n'}); if (!p.hasMoved && !b[r+2*dir]?.[c]) m.push({r: r+2*dir, c, type:'n'}); }
            [-1, 1].forEach(dc => {
                if (b[r+dir]?.[c+dc] && b[r+dir][c+dc].color !== p.color) m.push({r: r+dir, c: c+dc, type:'n'});
                if (enPassantTarget && r+dir === enPassantTarget.r && c+dc === enPassantTarget.c) m.push({r: r+dir, c: c+dc, type: 'enPassant'});
            });
        } else {
            const v = { 'r': [[0,1],[0,-1],[1,0],[-1,0]], 'b': [[1,1],[1,-1],[-1,1],[-1,-1]], 'n': [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]], 'q': [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]], 'k': [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]] };
            v[p.type].forEach(([dr, dc]) => {
                let nr=r+dr, nc=c+dc;
                while (nr>=0 && nr<8 && nc>=0 && nc<8) {
                    if (!b[nr][nc]) { m.push({r: nr, c: nc, type:'n'}); if ("nk".includes(p.type)) break; }
                    else { if (b[nr][nc].color !== p.color) m.push({r: nr, c: nc, type:'n'}); break; }
                    nr+=dr; nc+=dc;
                }
            });
        } return m;
    }

    function isCheck(color, b) {
        let k; for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(b[r][c]?.type==='k'&&b[r][c]?.color===color) k={r,c};
        if(!k) return false; const opp = color==='white'?'black':'white';
        for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(b[r][c]?.color===opp && getRawMoves(r,c,b).some(m=>m.r===k.r&&m.c===k.c)) return true;
        return false;
    }

    function hasLegalMoves(color) { for(let r=0; r<8; r++) for(let c=0; c<8; c++) if (board[r][c]?.color === color) if (getLegalMoves(r, c, board).length > 0) return true; return false; }
    function endGame(winner, reason) { gameActive = false; clearInterval(timerInterval); play('mate'); document.getElementById('win-overlay').style.display='flex'; document.getElementById('win-status').innerText=reason; document.getElementById('winner-label').innerText=pNames[winner].toUpperCase() + " WINS!"; }
    
    function updateLog(fC, tR, tC, isCap, type) {
        const container = document.getElementById('log-container'); const PNAME = { p:'', n:'N', b:'B', r:'R', q:'Q', k:'K' };
        const notation = (isCap && type === 'p' ? String.fromCharCode(97+fC) : PNAME[type]) + (isCap ? 'x' : '') + String.fromCharCode(97+tC) + (8-tR);
        if (turn === 'white') {
            const row = document.createElement('div'); row.className = 'log-row';
            row.innerHTML = `<div class="log-num">${moveCount}.</div><div>${notation}</div><div id="black-${moveCount}"></div>`;
            container.appendChild(row);
        } else { const el = document.getElementById(`black-${moveCount}`); if(el) el.innerText = notation; moveCount++; }
        container.scrollTop = container.scrollHeight;
    }

    function render() {
        const sqSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sq-size'));
        for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
            const sq = document.getElementById(`sq-${r}-${c}`); 
            if(!sq) continue;
            sq.className = `sq ${(r+c)%2===0 ? 'l' : 'd'}`;
            if (selected?.r === r && selected?.c === c) sq.classList.add('selected');
            if (legalMoves.some(m => m.r === r && m.c === c)) {
                const m = legalMoves.find(mv => mv.r === r && mv.c === c);
                if (m.type === 'castle' || m.type === 'enPassant') sq.classList.add('hint-special');
                else board[m.r][m.c] ? sq.classList.add('hint-capture') : sq.classList.add('hint-move');
            }
        }
        const layer = document.getElementById('piece-layer'); 
        if(layer) {
            layer.innerHTML='';
            board.forEach((row, r) => row.forEach((p, c) => { 
                if (p) { 
                    const el = document.createElement('div'); 
                    el.className = `piece ${p.color}-piece`; 
                    el.innerText = GLYPHS[p.color][p.type]; 
                    el.style.transform = `translate(${c * sqSize}px, ${r * sqSize}px)`; 
                    layer.appendChild(el); 
                } 
            }));
        }
    }
    window.addEventListener('resize', render);
    
    // Initial Render to prevent blank screen
    render();
})();
</script>
</body>
</html>
