<script>
(function() {
    // FIXED: Connects automatically to your Render URL
    const socket = io(); 

    const GLYPHS = { white: { k:'♔', q:'♕', r:'♖', b:'♗', n:'♘', p:'♙' }, black: { k:'♚', q:'♛', r:'♜', b:'♝', n:'♞', p:'♟' } };
    
    let board = [], turn = 'white', selected = null;
    let myRole = null, activeRoom = null;

    window.showLobby = () => { 
        document.getElementById('welcome-screen').style.display='none'; 
        document.getElementById('online-lobby-screen').style.display='flex'; 
    };

    window.createRoom = () => {
        const name = document.getElementById('p-name').value;
        if(!name) return alert("Enter Name");
        socket.emit('create-room', name);
    };

    window.joinRoom = () => {
        const name = document.getElementById('p-name').value;
        const code = document.getElementById('room-code').value.toUpperCase();
        if(!name || !code) return alert("Enter Name & Code");
        activeRoom = code; 
        socket.emit('join-room', { roomId: code, name });
    };

    socket.on('room-created', (id) => {
        activeRoom = id;
        document.getElementById('status-msg').innerHTML = `CODE: <b>${id}</b><br>Waiting for opponent...`;
    });

    socket.on('start-game', ({ opponent, color }) => {
        myRole = color;
        document.getElementById('online-lobby-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        initBoard();
        appendChat(`Match started! Opponent: ${opponent}`, 'system');
    });

    socket.on('remote-move', (m) => {
        executeMove(m.fR, m.fC, m.tR, m.tC, true);
    });

    socket.on('remote-chat', (msg) => appendChat(msg, 'them'));
    socket.on('error-msg', (msg) => alert(msg));

    function initBoard() {
        const layout = [
            ['r','n','b','q','k','b','n','r'],
            ['p','p','p','p','p','p','p','p'],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            ['P','P','P','P','P','P','P','P'],
            ['R','N','B','Q','K','B','N','R']
        ];
        board = layout.map(row => row.map(c => c ? { type: c.toLowerCase(), color: c === c.toUpperCase() ? 'white' : 'black' } : null));
        
        const grid = document.getElementById('board-grid');
        grid.innerHTML = '';
        for(let r=0; r<8; r++) {
            for(let c=0; c<8; c++) {
                const sq = document.createElement('div');
                sq.id = `sq-${r}-${c}`;
                sq.className = `sq ${(r+c)%2===0 ? 'l' : 'd'}`;
                sq.onclick = () => {
                    if (turn !== myRole) return; 
                    if (selected) {
                        if (selected.r === r && selected.c === c) { selected = null; }
                        else { executeMove(selected.r, selected.c, r, c); selected = null; }
                    } else {
                        if (board[r][c]?.color === turn) selected = {r, c};
                    }
                    render();
                };
                grid.appendChild(sq);
            }
        }
        render();
    }

    function executeMove(fR, fC, tR, tC, isRemote = false) {
        board[tR][tC] = board[fR][fC];
        board[fR][fC] = null;
        if (!isRemote) {
            socket.emit('move', { roomId: activeRoom, moveData: { fR, fC, tR, tC } });
        }
        turn = (turn === 'white') ? 'black' : 'white';
        render();
    }

    function render() {
        document.querySelectorAll('.sq').forEach(s => s.classList.remove('selected'));
        if (selected) document.getElementById(`sq-${selected.r}-${selected.c}`).classList.add('selected');
        const layer = document.getElementById('piece-layer');
        layer.innerHTML = '';
        const sqSize = 70; // Matches CSS
        board.forEach((row, r) => row.forEach((p, c) => {
            if (p) {
                const el = document.createElement('div');
                el.className = `piece ${p.color}-piece`;
                el.innerText = GLYPHS[p.color][p.type];
                el.style.transform = `translate(${c * sqSize}px, ${r * sqSize}px)`;
                layer.appendChild(el);
            }
        }));
    }

    window.sendMsg = () => {
        const inp = document.getElementById('chat-inp');
        if(!inp.value || !activeRoom) return;
        socket.emit('chat', { roomId: activeRoom, msg: inp.value });
        appendChat(inp.value, 'me');
        inp.value = '';
    };

    function appendChat(msg, side) {
        const div = document.createElement('div');
        div.className = `msg ${side}`;
        div.innerText = msg;
        document.getElementById('chat-msgs').appendChild(div);
        document.getElementById('chat-msgs').scrollTop = document.getElementById('chat-msgs').scrollHeight;
    }
})();
</script>
